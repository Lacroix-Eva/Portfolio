---
import Layout from "../../layouts/Layout.astro";

import pb from "../../../pocketbase/pb";

const projets = await pb.collection("Projets").getFullList();

const PB_BASE_URL = "https://portfolio.eva-lacroix.fr";
---

<Layout
  nomPage="Projets"
  description="Découvrez mes projets de création de sites web et d'interfaces digitales."
>
  <main class="px-5 lg:px-20">
    <div class="mt-2 lg:mt-8 mb-5 lg:mb-12">
      <style>
        /* style visuel pour l'état actif (le script ajoute/retire btn-primary) */
        #projects-filters .btn-primary {
          background-image: linear-gradient(
            to bottom,
            #520036,
            #42004f
          ) !important;
        }
      </style>

      <div id="projects-filters" class="flex gap-3 justify-center">
        <button
          type="button"
          data-filter="all"
          aria-pressed="true"
          class="filter-btn btn inline-flex w-max bg-linear-to-b from-secondary to-primary hover:from-info hover:to-success font-medium py-1 lg:py-2 items-center px-4 lg:px-5 rounded-4xl text-lg lg:text-2xl"
          >Tous</button
        >
        <button
          type="button"
          data-filter="Educatif"
          aria-pressed="false"
          class="filter-btn btn inline-flex w-max bg-linear-to-b from-secondary to-primary hover:from-info hover:to-success font-medium py-1 lg:py-2 items-center px-4 lg:px-5 rounded-4xl text-lg lg:text-2xl"
          >Académiques</button
        >
        <button
          type="button"
          data-filter="Personnel"
          aria-pressed="false"
          class="filter-btn btn inline-flex w-max bg-linear-to-b from-secondary to-primary hover:from-info hover:to-success font-medium py-1 lg:py-2 items-center px-4 lg:px-5 rounded-4xl text-lg lg:text-2xl"
          >Personnels</button
        >
      </div>
    </div>

    <div
      id="projects-grid"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-8"
    >
      {
        projets.map((project) => (
          <a
            href={`/projects/${project.id}`}
            data-categorie-filtre={project.categorie_filtre ?? ""}
            class="project-item block h-full"
          >
            <div class="project-card relative rounded-2xl overflow-hidden group lg:h-75 w-auto">
              <img
                src={`${PB_BASE_URL}/api/files/${project.collectionId}/${project.id}/${project.imageCouverture}`}
                alt={`visuel principal ${project.titre}`}
                class="w-full h-full object-cover"
                loading="eager"
              />

              <div
                class="absolute inset-0 group-hover:bg-black/75 pointer-events-none"
                aria-hidden="true"
              />

              <div class="absolute top-3 right-3 flex flex-col gap-2 items-end z-10 opacity-0 translate-y-2 group-hover:opacity-100 group-hover:translate-y-0 transition-all duration-300">
                {project.roleBadge1 ? (
                  <span class="text-xs lg:text-sm bg-linear-to-br from-primary to-accent px-3 py-1 rounded-full">
                    {project.roleBadge1}
                  </span>
                ) : null}
                {project.roleBadge2 ? (
                  <span class="text-xs lg:text-sm bg-linear-to-br from-primary to-accent px-3 py-1 rounded-full">
                    {project.roleBadge2}
                  </span>
                ) : null}
              </div>

              <div class="grid grid-cols-2">
                <div class="absolute left-3 bottom-3 z-10 opacity-0 translate-y-2 group-hover:opacity-100 group-hover:translate-y-0 transition-all duration-300">
                  {project.categorie ? (
                    <span class="inline-block text-xs lg:text-sm bg-linear-to-br from-primary to-accent px-3 py-1 rounded-full">
                      {project.categorie}
                    </span>
                  ) : null}
                  <div class="text-sm lg:text-base font-medium mt-2 group-hover:bg-black/50 group-hover:px-2 group-hover:py-1 group-hover:rounded-lg">
                    {project.titre}
                  </div>
                </div>
                <div class="absolute right-3 bottom-3 z-10 opacity-0 translate-y-2 group-hover:opacity-100 group-hover:translate-y-0 transition-all duration-300 text-sm lg:text-sm group-hover:bg-black/50 group-hover:px-2 group-hover:py-1 group-hover:rounded-lg">
                  {project.annee}
                </div>
              </div>
            </div>
          </a>
        ))
      }
    </div>

    <script>
      (function () {
        const grid = document.getElementById("projects-grid");
        const filterContainer = document.getElementById("projects-filters");
        if (!grid || !filterContainer) return;

        const buttons = Array.from(
          filterContainer.querySelectorAll(".filter-btn")
        );
        const cards = Array.from(grid.querySelectorAll(".project-item"));

        function applyFilter(value) {
          cards.forEach((card) => {
            const cat = (card.dataset.categorieFiltre || "").toString();
            const match = value === "all" || (cat && cat.includes(value));
            card.style.display = match ? "" : "none";
          });
        }

        filterContainer.addEventListener("click", (e) => {
          const btn = e.target.closest && e.target.closest(".filter-btn");
          if (!btn) return;
          const value = btn.dataset.filter;

          // update aria-pressed and active state
          buttons.forEach((b) => {
            const pressed = b === btn;
            b.setAttribute("aria-pressed", pressed ? "true" : "false");
            if (pressed) b.classList.add("btn-primary");
            else b.classList.remove("btn-primary");
          });

          applyFilter(value);
        });

        // init (show all)
        applyFilter("all");
        // set default active style
        buttons.forEach((b) => {
          if (b.dataset.filter === "all") b.classList.add("btn-primary");
        });
      })();
    </script>
  </main>
</Layout>
